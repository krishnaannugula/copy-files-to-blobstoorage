# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- master

variables:
  vmImageName: windows-latest


stages:
- stage: Build
  displayName: Build stage
  jobs:
  - job: Build
    displayName: Build
    pool:
      vmImage: $(vmImageName)
    steps:
      - checkout: self
        clean: true
      - task: CopyFiles@2
        displayName: copy files from
        inputs:
          SourceFolder: 'TestStorage'
          Contents: '**'
          TargetFolder: '$(Build.ArtifactStagingDirectory)'
      - task: PublishBuildArtifacts@1
        displayName: 'Publish Artifact: drop'
    
    #####Release######

- stage: DeployStaging
  displayName: Deploy Staging
  dependsOn: Build
  condition: succeeded()
  jobs:
  - deployment: Deploy
    displayName: Deploy
    environment: Staging
    pool:
      vmImage: $(vmImageName)
    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzureFileCopy@3
            displayName: 'AzureBlob File Copy'
            inputs:
              SourcePath: '$(Pipeline.Workspace)/drop'
              azureSubscription: 'Azure for Students(1)(fe0e1401-29d7-4a84-8b63-24d1d6c39189)'
              Destination: 'AzureBlob'
              storage: $(STAGINGSTORAGE)
              ContainerName: 'input'
              sasTokenTimeOutInMinutes: '240'


          - task: PowerShell@2
            inputs:
              targetType: 'inline'
              script: |
                # Write your PowerShell commands here.
                
                $webhookURL =
                "https://kacorp173.webhook.office.com/webhookb2/65ec2ae1-1b20-4824-9811-feafb8ab253a@82bb0453-fb71-4ed9-a94c-9630e87971bc/IncomingWebhook/7386130c16984f2c8cd7dd8bb5ec6e0c/e1d27e51-b97e-471a-b7e9-ef6bd1c604c6"

                $messageCardBody=@"
                { "@type": "MessageCard", "@context": "https://schema.org/extensions", "summary": "1 new build message", "themeColor": "0078D7", "sections": [ { "activityImage": "https://cdn2.iconfinder.com/data/icons/weby-flat-vol-1/512/1_Approved-check-checkbox-confirm-green-success-tick-512.png", "activityTitle": "Notification", "activitySubtitle": "Copy Files", "facts": [ { "name": "EnvName:", "value": "$(Environment.Name)" }, { "name": "ApplicationName:", "value": "${env:STAGINGSTORAGE}" },{ "name": "BuildNumber:", "value": "$(Build.BuildNumber)" },{ "name": "BuildStatus:", "value": "$(Agent.JobStatus)" } ], "text": "Deployment to $(Environment.Name)", "potentialAction": [  ] } ] }
                "@
                echo ${messageCardBody}
                echo ${env:STAGINGSTORAGE}

                Invoke-RestMethod -uri $webhookURL -Method Post -body $messageCardBody -ContentType ‘application/json’     



            #####production Release required approval######

- stage: DeployProduction
  displayName: Deploy Production
  dependsOn: DeployStaging
  condition: succeeded()
  jobs:
  - deployment: Deploy
    displayName: Deploy
    environment: Production
    pool:
      vmImage: $(vmImageName)
    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzureFileCopy@3
            displayName: 'AzureBlob File Copy'
            inputs:
              SourcePath: '$(Pipeline.Workspace)/drop'
              azureSubscription: 'Azure for Students(1)(fe0e1401-29d7-4a84-8b63-24d1d6c39189)'
              Destination: 'AzureBlob'
              storage: $(PRODUCTIONSTORAGE)
              ContainerName: 'input'
              sasTokenTimeOutInMinutes: '240'



          - task: PowerShell@2
            inputs:
              targetType: 'inline'
              script: |
                # Write your PowerShell commands here.
                
                $webhookURL =
                "https://kacorp173.webhook.office.com/webhookb2/65ec2ae1-1b20-4824-9811-feafb8ab253a@82bb0453-fb71-4ed9-a94c-9630e87971bc/IncomingWebhook/7386130c16984f2c8cd7dd8bb5ec6e0c/e1d27e51-b97e-471a-b7e9-ef6bd1c604c6"

                $messageCardBody=@"
                { "@type": "MessageCard", "@context": "https://schema.org/extensions", "summary": "1 new build message", "themeColor": "0078D7", "sections": [ { "activityImage": "https://cdn2.iconfinder.com/data/icons/weby-flat-vol-1/512/1_Approved-check-checkbox-confirm-green-success-tick-512.png", "activityTitle": "Notification", "activitySubtitle": "Copy Files", "facts": [ { "name": "EnvName:", "value": "$(Environment.Name)" }, { "name": "ApplicationName:", "value": "${env:PRODUCTIONSTORAGE}" },{ "name": "BuildNumber:", "value": "$(Build.BuildNumber)" },{ "name": "BuildStatus:", "value": "$(Agent.JobStatus)" }], "text": "Deployment to $(Environment.Name)", "potentialAction": [  ] } ] }
                "@
                echo ${messageCardBody}
                echo ${env:PRODUCTIONSTORAGE}

                Invoke-RestMethod -uri $webhookURL -Method Post -body $messageCardBody -ContentType ‘application/json’         